///|
test "contract reference line is selected by output profile" {
  let p1 = contract_reference_line_for_output_dir("src/p1")
  let p2 = contract_reference_line_for_output_dir("./src/p2/")
  let p3 = contract_reference_line_for_output_dir("src/p3")
  let unknown = contract_reference_line_for_output_dir("src/other")
  guard p1 is Some(p1_line) else { abort("missing p1 reference") }
  guard p2 is Some(p2_line) else { abort("missing p2 reference") }
  guard p3 is Some(p3_line) else { abort("missing p3 reference") }
  assert_true(p1_line.contains("wasi_snapshot_preview1"))
  assert_true(p2_line.contains("wasi:*@0.2.9"))
  assert_true(p3_line.contains("wasi:*@0.3.0-draft"))
  assert_true(unknown is None)
}

///|
test "generated module code is annotated with contract reference" {
  let raw = "///| Generated by wasi_interface WIT adapter generator.\n"
  let annotated = annotate_generated_module_code("src/p2", raw)
  assert_true(annotated.has_prefix("///| Contract reference: WASIp2"))
  assert_true(annotated.contains("Generated by wasi_interface"))
  let unchanged = annotate_generated_module_code("src/other", raw)
  assert_eq(unchanged, raw)
}
